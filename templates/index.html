<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatroom com Fernet</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen font-sans">

    <div class="container bg-gray-800 w-full max-w-lg p-6 rounded-lg shadow-lg border border-gray-700">
        <div id="login-view">
            <h2 class="text-2xl font-bold mb-6 text-center text-gray-200">Entrar no Chat ðŸ’¬</h2>
            <div class="space-y-4">
                <input type="text" id="username-input" placeholder="Digite seu nome" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
                <input type="text" id="room-input" placeholder="Digite o nome da sala" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
                <button id="join-button" class="w-full py-3 bg-blue-600 hover:bg-blue-700 rounded-md font-semibold transition-colors">Entrar</button>
            </div>
        </div>

        <div id="chat-view" style="display: none;">
            <h3 id="room-title" class="text-xl font-semibold mb-3 text-center text-gray-300"></h3>
            <div id="chat-area" class="h-96 bg-gray-900 border border-gray-700 rounded-md p-4 overflow-y-auto mb-4 flex flex-col gap-3">
                </div>
            <div class="flex">
                <input type="text" id="message-input" placeholder="Digite sua mensagem" class="flex-grow p-3 bg-gray-700 border border-gray-600 rounded-l-md focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
                <button id="send-button" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 rounded-r-md font-semibold transition-colors">Enviar</button>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.socket.io/4.4.1/socket.io.min.js" integrity="sha384-fKnu0iswBIqkjxrhQCTZ7qlLHOFEgNkRmK2vaO/LbTZSXdJfAu6ewRBdwHPhBo/H" crossorigin="anonymous"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const socket = io();
            
            const loginView = document.getElementById('login-view');
            const chatView = document.getElementById('chat-view');
            
            const joinButton = document.getElementById('join-button');
            const usernameInput = document.getElementById('username-input');
            const roomInput = document.getElementById('room-input');
            
            const roomTitle = document.getElementById('room-title');
            const sendButton = document.getElementById('send-button');
            const messageInput = document.getElementById('message-input');
            const chatArea = document.getElementById('chat-area');
            
            let currentRoom = '';
            let currentUsername = '';

            const joinRoom = () => {
                const username = usernameInput.value.trim();
                const roomName = roomInput.value.trim();

                if (username && roomName) {
                    currentUsername = username;
                    currentRoom = roomName;

                    socket.emit('join', { username: currentUsername, room: currentRoom });
                    
                    loginView.style.display = 'none';
                    chatView.style.display = 'block';
                    roomTitle.innerText = `Sala: ${currentRoom}`;
                    messageInput.focus();
                } else {
                    alert('Por favor, preencha seu nome e o nome da sala.');
                }
            };

            joinButton.addEventListener('click', joinRoom);
            roomInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') joinRoom();
            });

            const sendMessage = async () => {
                const message = messageInput.value.trim();
                if (!message) return;

                const response = await fetch('/encrypt', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ room: currentRoom, message: message })
                });
                const data = await response.json();

                if (data.encrypted) {
                    socket.emit('send_message', { message: data.encrypted });
                    messageInput.value = '';
                }
            };

            sendButton.addEventListener('click', sendMessage);
            messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage();
            });
            
            socket.on('new_encrypted_message', async (data) => {
                const encryptedMsg = data.encrypted_msg;
                const username = data.username;
                
                const response = await fetch('/decrypt', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ room: currentRoom, encrypted_message: encryptedMsg })
                });
                const decryptedData = await response.json();
                
                if (decryptedData.decrypted) {
                    
                    const messageWrapper = document.createElement('div');
                    messageWrapper.className = 'w-full flex';

                    const messageBubble = document.createElement('div');
                    messageBubble.className = 'p-3 rounded-lg max-w-md break-words'; 
                    
                    if (username === currentUsername) {
                        messageWrapper.classList.add('justify-end');
                        messageBubble.classList.add('bg-blue-800', 'text-white');
                        messageBubble.innerText = decryptedData.decrypted;
                    } else {
                        messageWrapper.classList.add('justify-start');
                        messageBubble.classList.add('bg-gray-700');
                        messageBubble.innerHTML = `<strong class="text-blue-400">${username}:</strong> ${decryptedData.decrypted}`;
                    }
                    
                    messageWrapper.appendChild(messageBubble);
                    chatArea.appendChild(messageWrapper);

                }
                chatArea.scrollTop = chatArea.scrollHeight;
            });

            socket.on('status', (data) => {
                const statusDiv = document.createElement('div');
                statusDiv.className = 'text-center text-gray-500 italic text-sm';
                statusDiv.innerHTML = `<p>${data.msg}</p>`;
                chatArea.appendChild(statusDiv);
                chatArea.scrollTop = chatArea.scrollHeight;
            });
        });
    </script>
</body>
</html>